<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Miss√µes Espaciais - Jogo de Recupera√ß√£o</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0f0f23, #1a1a3e, #2d1b69);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        .container {
            position: relative;
            z-index: 10;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .screen {
            display: none;
            text-align: center;
            background: rgba(0, 0, 0, 0.7);
            padding: 40px;
            border-radius: 20px;
            border: 2px solid #4a90e2;
            box-shadow: 0 0 30px rgba(74, 144, 226, 0.3);
        }

        .screen.active {
            display: block;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .rocket {
            font-size: 60px;
            margin-bottom: 20px;
            animation: float 2s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        h1 {
            color: #4a90e2;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(74, 144, 226, 0.5);
        }

        .input-group {
            margin: 20px 0;
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #ccc;
        }

        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #4a90e2;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 16px;
        }

        input:focus {
            outline: none;
            box-shadow: 0 0 10px rgba(74, 144, 226, 0.5);
        }

        .motivational-quote {
            font-style: italic;
            color: #ffd700;
            margin: 20px 0;
            font-size: 18px;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.3);
        }

        .btn {
            background: linear-gradient(45deg, #4a90e2, #357abd);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 25px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 144, 226, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .mission-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .mission-card {
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid #4a90e2;
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mission-card:hover {
            border-color: #ffd700;
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        .mission-card h3 {
            color: #4a90e2;
            margin-bottom: 10px;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .score {
            background: rgba(255, 215, 0, 0.2);
            padding: 10px 20px;
            border-radius: 20px;
            border: 2px solid #ffd700;
        }

        .challenge-info {
            text-align: left;
            margin-bottom: 30px;
        }

        .hint {
            background: rgba(74, 144, 226, 0.2);
            border-left: 4px solid #4a90e2;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .answer-input {
            margin: 20px 0;
        }

        .feedback {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: bold;
        }

        .correct {
            background: rgba(0, 255, 0, 0.2);
            border: 2px solid #00ff00;
            color: #00ff00;
        }

        .incorrect {
            background: rgba(255, 0, 0, 0.2);
            border: 2px solid #ff0000;
            color: #ff0000;
        }

        .certificate {
            background: linear-gradient(135deg, #ffd700, #ffed4a);
            color: #333;
            border-radius: 20px;
            padding: 40px;
            margin: 20px 0;
            border: 5px solid #d4af37;
        }

        .certificate h2 {
            color: #8b4513;
            margin-bottom: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background: linear-gradient(45deg, #4a90e2, #357abd);
            transition: width 0.5s ease;
        }

        .planet {
            position: absolute;
            border-radius: 50%;
            opacity: 0.1;
        }

        .planet1 {
            width: 100px;
            height: 100px;
            background: #ff6b6b;
            top: 10%;
            right: 10%;
            animation: orbit 20s linear infinite;
        }

        .planet2 {
            width: 60px;
            height: 60px;
            background: #4ecdc4;
            bottom: 20%;
            left: 5%;
            animation: orbit 15s linear infinite reverse;
        }

        @keyframes orbit {
            from { transform: rotate(0deg) translateX(50px) rotate(0deg); }
            to { transform: rotate(360deg) translateX(50px) rotate(-360deg); }
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
            transition: all 0.3s;
        }

        .connected {
            background: rgba(0, 255, 0, 0.2);
            border: 2px solid #00ff00;
            color: #00ff00;
        }

        .disconnected {
            background: rgba(255, 0, 0, 0.2);
            border: 2px solid #ff0000;
            color: #ff0000;
        }

        .ranking-screen {
            text-align: left;
        }

        .ranking-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .ranking-table th,
        .ranking-table td {
            padding: 12px;
            border-bottom: 1px solid #4a90e2;
            text-align: left;
        }

        .ranking-table th {
            background: rgba(74, 144, 226, 0.2);
            color: #4a90e2;
        }

        .ranking-table tr:nth-child(even) {
            background: rgba(0, 0, 0, 0.3);
        }

        .ranking-table tr:hover {
            background: rgba(74, 144, 226, 0.1);
        }

        .medal {
            font-size: 20px;
            margin-right: 5px;
        }

        .loading {
            text-align: center;
            color: #ffd700;
            font-style: italic;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid #4a90e2;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            color: #ffd700;
            font-weight: bold;
        }

        .download-section {
            margin: 30px 0;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            border: 2px solid #ffd700;
        }

        #certificateCanvas {
            max-width: 100%;
            height: auto;
            border: 3px solid #d4af37;
            border-radius: 10px;
            margin: 20px 0;
        }
            .container {
                padding: 10px;
            }
            
            .game-header {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">
        üîÑ Conectando...
    </div>
    <div class="stars" id="stars"></div>
    <div class="planet planet1"></div>
    <div class="planet planet2"></div>

    <div class="container">
        <!-- Tela Inicial -->
        <div class="screen active" id="startScreen">
            <div class="rocket">üöÄ</div>
            <h1>Miss√µes Espaciais</h1>
            <p class="motivational-quote">"Cada desafio √© uma fase. Cada resposta, uma chave para dominar o territ√≥rio. Pronto para jogar?"</p>
            
            <div class="input-group">
                <label for="playerName">Nome do Agente:</label>
                <input type="text" id="playerName" placeholder="Digite seu nome">
            </div>
            
            <div class="input-group">
                <label for="playerCPF">CPF:</label>
                <input type="text" id="playerCPF" placeholder="Digite seu CPF">
            </div>
            
            <button class="btn" onclick="startGame()">Iniciar Miss√£o</button>
            <button class="btn" onclick="showRanking()" style="background: linear-gradient(45deg, #ffd700, #ffed4a); color: #333;">üèÜ Ver Ranking</button>
        </div>

        <!-- Ranking -->
        <div class="screen ranking-screen" id="rankingScreen">
            <h1>üèÜ Ranking dos Agentes</h1>
            
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-number" id="totalPlayers">-</div>
                    <div>Total de Agentes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgScore">-</div>
                    <div>Pontua√ß√£o M√©dia</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="bestScore">-</div>
                    <div>Melhor Pontua√ß√£o</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgPercentage">-</div>
                    <div>Taxa de Acerto M√©dia</div>
                </div>
            </div>

            <div id="rankingContainer">
                <div class="loading">Carregando ranking...</div>
            </div>
            
            <button class="btn" onclick="showScreen('startScreen')">Voltar</button>
        </div>

        <!-- Sele√ß√£o de Miss√µes -->
        <div class="screen" id="missionSelect">
            <h1>Sua Miss√£o Est√° Pronta</h1>
            <div class="mission-grid">
                <div class="mission-card" onclick="selectMission(0)">
                    <div style="color: #ffd700; font-weight: bold; margin-bottom: 10px;">Treinamento PF</div>
                    <h3>üåç Miss√£o - Mundo Over PF</h3>
                    <p>6 Desafios</p>
                    <p>Domine os conceitos da recupera√ß√£o intensiva</p>
                </div>
            </div>
        </div>

        <!-- Jogo -->
        <div class="screen" id="gameScreen">
            <div class="game-header">
                <h2 id="missionTitle"></h2>
                <div class="score">
                    Pontos: <span id="score">0</span>
                </div>
            </div>
            
            <div class="progress-bar">
                <div class="progress" id="progress"></div>
            </div>
            
            <div class="challenge-info">
                <h3 id="challengeTitle"></h3>
                <div id="hintsContainer"></div>
            </div>
            
            <div class="answer-input">
                <input type="text" id="answerInput" placeholder="Digite sua resposta">
                <button class="btn" onclick="submitAnswer()">Enviar Resposta</button>
                <button class="btn" id="hintBtn" onclick="requestHint()" style="background: linear-gradient(45deg, #ffd700, #ffed4a); color: #333;">üí° Solicitar Pista</button>
            </div>
            
            <div id="feedback"></div>
            
            <button class="btn" id="nextBtn" onclick="nextChallenge()" style="display: none;">Pr√≥ximo Desafio</button>
        </div>

        <!-- Resultado Final -->
        <div class="screen" id="resultScreen">
            <h1>Miss√£o Conclu√≠da!</h1>
            <div id="finalScore"></div>
            
            <div class="certificate">
                <h2>üèÜ CERTIFICADO DE CONCLUS√ÉO üèÜ</h2>
                <p>Certificamos que</p>
                <h3 id="certificateName"></h3>
                <p>completou com sucesso as</p>
                <h3>MISS√ïES ESPACIAIS</h3>
                <p>demonstrando conhecimento em recupera√ß√£o financeira</p>
                <p id="certificateDate"></p>
                <p><strong>Pontua√ß√£o:</strong> <span id="certificateScore"></span> pontos</p>
            </div>
            
            <div class="download-section">
                <h3>üíæ Baixar Certificado</h3>
                <p>Clique no bot√£o abaixo para baixar seu certificado como imagem</p>
                <button class="btn" onclick="downloadCertificate()" id="downloadBtn">üì∏ Baixar Certificado</button>
            </div>
            
            <button class="btn" onclick="restartGame()">Nova Miss√£o</button>
            <button class="btn" onclick="showRanking()" style="background: linear-gradient(45deg, #ffd700, #ffed4a); color: #333;">üèÜ Ver Ranking</button>
        </div>
    </div>

    <script>
        // Configura√ß√£o do Supabase
        const SUPABASE_URL = 'https://tzpabhwwkzsaaftpyuqd.supabase.co'; // Substitua pela sua URL do Supabase
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6cGFiaHd3a3pzYWFmdHB5dXFkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2Njk2NjMsImV4cCI6MjA3MDI0NTY2M30.2W8ax4GAPTknZE-Uxc3lgKissPO5pATp4PS09NGQamg'; // Substitua pela sua chave an√¥nima
        
        // Inicializar cliente Supabase (s√≥ se as credenciais estiverem configuradas)
        let supabase = null;
        let isSupabaseConnected = false;
        
        if (SUPABASE_URL !== 'YOUR_SUPABASE_URL' && SUPABASE_ANON_KEY !== 'YOUR_SUPABASE_ANON_KEY') {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                testConnection();
            } catch (error) {
                console.error('Erro ao conectar com Supabase:', error);
                updateConnectionStatus(false);
            }
        } else {
            updateConnectionStatus(false, 'Configura√ß√£o pendente');
        }

        // Testar conex√£o com Supabase
        async function testConnection() {
            try {
                const { data, error } = await supabase
                    .from('quiz_results')
                    .select('count(*)')
                    .limit(1);
                
                if (error && error.code !== 'PGRST116') { // PGRST116 = tabela n√£o encontrada (esperado)
                    throw error;
                }
                
                updateConnectionStatus(true);
                isSupabaseConnected = true;
            } catch (error) {
                console.error('Erro de conex√£o:', error);
                updateConnectionStatus(false, 'Erro de conex√£o');
                isSupabaseConnected = false;
            }
        }

        // Atualizar status de conex√£o na UI
        function updateConnectionStatus(connected, message = '') {
            const statusElement = document.getElementById('connectionStatus');
            
            if (connected) {
                statusElement.className = 'connection-status connected';
                statusElement.innerHTML = '‚úÖ Supabase Conectado';
            } else {
                statusElement.className = 'connection-status disconnected';
                statusElement.innerHTML = `‚ùå Supabase ${message || 'Desconectado'}`;
            }
        }

        // Dados do jogo
        const missions = [
            {
                name: "üåç Miss√£o - Mundo Over PF",
                challenges: [
                    {
                        title: "Desafio 1: Qual √© o setor respons√°vel pela recupera√ß√£o intensiva?",
                        hints: [
                            "Sou como uma sala de cirurgia no mundo financeiro.",
                            "Neg√≥cio produtos com mais de 90 dias de atraso, mas posso agir antes disso tamb√©m.",
                            "Quando entro em a√ß√£o, os limites s√£o cancelados e o foco √© total na recupera√ß√£o."
                        ],
                        answer: "mundo over"
                    },
                    {
                        title: "Desafio 2: Que estrat√©gia permite agir antes dos 90 dias?",
                        hints: [
                            "Sou uma forma de migrar produtos ainda na fase preventiva para o tratamento intensivo.",
                            "Posso ser aplicada a cart√µes, contas correntes e empr√©stimos sem garantia.",
                            "Trago benef√≠cios como menores taxas, mas cancelo todos os limites."
                        ],
                        answer: "antecipa√ß√£o"
                    },
                    {
                        title: "Desafio 3: Qual √© o est√°gio preventivo da recupera√ß√£o?",
                        hints: [
                            "Sou comparado a um check-up m√©dico.",
                            "Atuo at√© os 89 dias de atraso, mantendo o relacionamento com o cliente.",
                            "Sou o est√°gio anterior ao Mundo Over."
                        ],
                        answer: "origem"
                    },
                    {
                        title: "Desafio 4: Quais produtos podem ser negociados no Over?",
                        hints: [
                            "Incluo faturas de cart√£o, limites de conta corrente e empr√©stimos.",
                            "Tamb√©m negocio ve√≠culos com mais de 92 dias de atraso.",
                            "Sou o foco principal das estrat√©gias de recupera√ß√£o."
                        ],
                        answer: "cart√£o, conta corrente, empr√©stimos e ve√≠culos"
                    },
                    {
                        title: "Desafio 5: Quais filas s√£o proibidas na negocia√ß√£o?",
                        hints: [
                            "Sou como √°reas restritas em um jogo.",
                            "Incluo a√ß√µes jur√≠dicas e casos de alto risco.",
                            "N√£o posso ser negociado no Mundo Over."
                        ],
                        answer: "fila p acima de 100k, fila j, fila r e s35"
                    },
                    {
                        title: "Desafio 6: Para onde v√£o os casos que voltam a atrasar ap√≥s o acordo?",
                        hints: [
                            "Sou um universo com regras pr√≥prias.",
                            "Recebo os casos que voltam a atrasar ap√≥s negocia√ß√£o no Over.",
                            "Aqui, voc√™ come√ßa uma nova miss√£o como agente da recupera√ß√£o."
                        ],
                        answer: "mundo quebra"
                    }
                ]
            }
        ];

        // Vari√°veis do jogo
        let playerName = '';
        let playerCPF = '';
        let currentMission = 0;
        let currentChallenge = 0;
        let currentHints = 0;
        let totalScore = 0;
        let challengesCompleted = 0;
        let gameStartTime = null;
        let challengeStartTime = null;
        let totalAttempts = 0;
        let totalHintsUsed = 0;
        let challengeDetails = [];

        // Inicializar estrelas
        function createStars() {
            const starsContainer = document.getElementById('stars');
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.width = star.style.height = Math.random() * 3 + 1 + 'px';
                star.style.animationDelay = Math.random() * 3 + 's';
                starsContainer.appendChild(star);
            }
        }

        // Iniciar jogo
        function startGame() {
            playerName = document.getElementById('playerName').value.trim();
            playerCPF = document.getElementById('playerCPF').value.trim();
            
            if (!playerName || !playerCPF) {
                alert('Por favor, preencha todos os campos!');
                return;
            }
            
            showScreen('missionSelect');
        }

        // Selecionar miss√£o
        function selectMission(missionIndex) {
            currentMission = missionIndex;
            currentChallenge = 0;
            currentHints = 0;
            challengesCompleted = 0;
            totalAttempts = 0;
            totalHintsUsed = 0;
            challengeDetails = [];
            gameStartTime = new Date();
            
            document.getElementById('missionTitle').textContent = missions[currentMission].name;
            loadChallenge();
            showScreen('gameScreen');
        }

        // Carregar desafio
        function loadChallenge() {
            const challenge = missions[currentMission].challenges[currentChallenge];
            const totalChallenges = missions[currentMission].challenges.length;
            
            document.getElementById('challengeTitle').textContent = challenge.title;
            document.getElementById('hintsContainer').innerHTML = '';
            document.getElementById('answerInput').value = '';
            document.getElementById('feedback').innerHTML = '';
            document.getElementById('nextBtn').style.display = 'none';
            
            currentHints = 0;
            challengeStartTime = new Date();
            showNextHint();
            updateHintButton();
            
            // Atualizar barra de progresso
            const progress = ((challengesCompleted) / totalChallenges) * 100;
            document.getElementById('progress').style.width = progress + '%';
        }

        // Mostrar pr√≥xima dica
        function showNextHint() {
            if (currentHints < 3) {
                const challenge = missions[currentMission].challenges[currentChallenge];
                const hintsContainer = document.getElementById('hintsContainer');
                
                const hintElement = document.createElement('div');
                hintElement.className = 'hint';
                hintElement.innerHTML = `<strong>Pista ${currentHints + 1}:</strong> ${challenge.hints[currentHints]}`;
                hintsContainer.appendChild(hintElement);
                
                currentHints++;
                updateHintButton();
            }
        }

        // Atualizar bot√£o de pistas
        function updateHintButton() {
            const hintBtn = document.getElementById('hintBtn');
            if (currentHints >= 3) {
                hintBtn.style.display = 'none';
            } else {
                hintBtn.style.display = 'inline-block';
                hintBtn.textContent = `üí° Solicitar Pista (${3 - currentHints} restantes)`;
            }
        }

        // Solicitar pista manual
        function requestHint() {
            if (currentHints < 3) {
                showNextHint();
                totalHintsUsed++;
            }
        }

        // Enviar resposta
        function submitAnswer() {
            const userAnswer = document.getElementById('answerInput').value.trim().toLowerCase();
            const correctAnswer = missions[currentMission].challenges[currentChallenge].answer.toLowerCase();
            const feedbackElement = document.getElementById('feedback');
            
            if (!userAnswer) {
                alert('Por favor, digite uma resposta!');
                return;
            }
            
            totalAttempts++;
            const responseTime = Math.floor((new Date() - challengeStartTime) / 1000);
            
            // Verificar se a resposta cont√©m palavras-chave da resposta correta
            const correctWords = correctAnswer.split(' ');
            const userWords = userAnswer.split(' ');
            const matches = correctWords.filter(word => 
                userWords.some(userWord => 
                    userWord.includes(word) || word.includes(userWord)
                )
            );
            
            const isCorrect = matches.length >= Math.ceil(correctWords.length * 0.7); // 70% das palavras devem corresponder
            
            // Registrar detalhes do desafio
            const challengeDetail = {
                numero_desafio: currentChallenge + 1,
                titulo_desafio: missions[currentMission].challenges[currentChallenge].title,
                dicas_usadas: currentHints,
                tentativas: 1, // Contamos apenas uma tentativa por desafio
                acertou: isCorrect,
                resposta_usuario: userAnswer,
                resposta_correta: correctAnswer,
                tempo_resposta_segundos: responseTime,
                pontos_obtidos: 0
            };
            
            if (isCorrect) {
                // Resposta correta
                let points = 0;
                if (currentHints === 1) points = 10;
                else if (currentHints === 2) points = 5;
                else if (currentHints === 3) points = 3;
                
                totalScore += points;
                challengesCompleted++;
                challengeDetail.pontos_obtidos = points;
                
                feedbackElement.innerHTML = `
                    <div class="feedback correct">
                        üéâ Correto! Voc√™ ganhou ${points} pontos!
                        <br>Resposta: ${missions[currentMission].challenges[currentChallenge].answer}
                    </div>
                `;
                
                document.getElementById('score').textContent = totalScore;
                document.getElementById('nextBtn').style.display = 'inline-block';
                document.getElementById('hintBtn').style.display = 'none';
                
            } else {
                // Resposta incorreta
                feedbackElement.innerHTML = `
                    <div class="feedback incorrect">
                        ‚ùå Resposta incorreta. ${currentHints < 3 ? 'Voc√™ pode solicitar mais pistas ou tentar novamente!' : 'A resposta correta era: ' + missions[currentMission].challenges[currentChallenge].answer}
                    </div>
                `;
                
                if (currentHints >= 3) {
                    challengesCompleted++;
                    document.getElementById('nextBtn').style.display = 'inline-block';
                    document.getElementById('hintBtn').style.display = 'none';
                }
            }
            
            challengeDetails.push(challengeDetail);
        }currentHints < 3 ? 'Voc√™ pode solicitar mais pistas ou tentar novamente!' : 'A resposta correta era: ' + missions[currentMission].challenges[currentChallenge].answer}
                    </div>
                `;
                
                if (currentHints >= 3) {
                    challengesCompleted++;
                    document.getElementById('nextBtn').style.display = 'inline-block';
                    document.getElementById('hintBtn').style.display = 'none';
                }
            }
        }

        // Pr√≥ximo desafio
        function nextChallenge() {
            currentChallenge++;
            
            if (currentChallenge < missions[currentMission].challenges.length) {
                loadChallenge();
            } else {
                showResults();
            }
        }

        // Mostrar resultados
        async function showResults() {
            const totalChallenges = missions[currentMission].challenges.length;
            const maxScore = totalChallenges * 10;
            const percentage = Math.round((totalScore / maxScore) * 100);
            const totalTimeSeconds = Math.floor((new Date() - gameStartTime) / 1000);
            
            document.getElementById('finalScore').innerHTML = `
                <h2>Sua Pontua√ß√£o: ${totalScore} pontos</h2>
                <p>Desempenho: ${percentage}%</p>
                <p>Tempo Total: ${Math.floor(totalTimeSeconds / 60)}:${(totalTimeSeconds % 60).toString().padStart(2, '0')}</p>
                <p>Total de Dicas Usadas: ${totalHintsUsed}</p>
                <p>Total de Tentativas: ${totalAttempts}</p>
            `;
            
            document.getElementById('certificateName').textContent = playerName;
            document.getElementById('certificateDate').textContent = new Date().toLocaleDateString('pt-BR');
            document.getElementById('certificateScore').textContent = totalScore;
            
            // Salvar resultado no Supabase
            if (isSupabaseConnected) {
                try {
                    await saveResultToSupabase(percentage, totalTimeSeconds);
                } catch (error) {
                    console.error('Erro ao salvar resultado:', error);
                }
            }
            
            showScreen('resultScreen');
        }

        // Salvar resultado no Supabase
        async function saveResultToSupabase(percentage, totalTimeSeconds) {
            if (!supabase) return;
            
            try {
                const { data, error } = await supabase.rpc('inserir_resultado_quiz', {
                    p_nome: playerName,
                    p_cpf: playerCPF,
                    p_pontuacao: totalScore,
                    p_total_dicas: totalHintsUsed,
                    p_total_tentativas: totalAttempts,
                    p_tempo_total: totalTimeSeconds,
                    p_percentual: percentage,
                    p_missao: missions[currentMission].name,
                    p_desafios_completados: challengesCompleted,
                    p_data_inicio: gameStartTime.toISOString(),
                    p_detalhes_desafios: challengeDetails
                });

                if (error) {
                    throw error;
                }

                console.log('Resultado salvo com sucesso!');
            } catch (error) {
                console.error('Erro ao salvar no Supabase:', error);
            }
        }

        // Download do certificado
        async function downloadCertificate() {
            const certificate = document.querySelector('.certificate');
            const downloadBtn = document.getElementById('downloadBtn');
            
            downloadBtn.textContent = 'Gerando certificado...';
            downloadBtn.disabled = true;
            
            try {
                const canvas = await html2canvas(certificate, {
                    backgroundColor: '#1a1a3e',
                    scale: 2,
                    width: certificate.offsetWidth,
                    height: certificate.offsetHeight
                });
                
                // Criar link para download
                const link = document.createElement('a');
                link.download = `certificado_${playerName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.png`;
                link.href = canvas.toDataURL();
                link.click();
                
            } catch (error) {
                console.error('Erro ao gerar certificado:', error);
                alert('Erro ao gerar certificado. Tente novamente.');
            } finally {
                downloadBtn.textContent = 'üì∏ Baixar Certificado';
                downloadBtn.disabled = false;
            }
        }

        // Mostrar ranking
        async function showRanking() {
            showScreen('rankingScreen');
            
            if (!isSupabaseConnected) {
                document.getElementById('rankingContainer').innerHTML = `
                    <div style="text-align: center; color: #ff6b6b; padding: 40px;">
                        ‚ö†Ô∏è Ranking indispon√≠vel<br>
                        <small>Supabase n√£o est√° conectado</small>
                    </div>
                `;
                return;
            }
            
            try {
                // Carregar estat√≠sticas gerais
                await loadStatistics();
                
                // Carregar ranking
                await loadRanking();
                
            } catch (error) {
                console.error('Erro ao carregar ranking:', error);
                document.getElementById('rankingContainer').innerHTML = `
                    <div style="text-align: center; color: #ff6b6b; padding: 40px;">
                        ‚ùå Erro ao carregar ranking<br>
                        <small>${error.message}</small>
                    </div>
                `;
            }
        }

        // Carregar estat√≠sticas
        async function loadStatistics() {
            try {
                const { data, error } = await supabase
                    .from('estatisticas_gerais')
                    .select('*')
                    .single();

                if (error) throw error;

                document.getElementById('totalPlayers').textContent = data.total_jogadores || 0;
                document.getElementById('avgScore').textContent = Math.round(data.pontuacao_media || 0);
                document.getElementById('bestScore').textContent = data.maior_pontuacao || 0;
                document.getElementById('avgPercentage').textContent = Math.round(data.percentual_medio || 0) + '%';
            } catch (error) {
                console.error('Erro ao carregar estat√≠sticas:', error);
                // Valores padr√£o em caso de erro
                document.getElementById('totalPlayers').textContent = '0';
                document.getElementById('avgScore').textContent = '0';
                document.getElementById('bestScore').textContent = '0';
                document.getElementById('avgPercentage').textContent = '0%';
            }
        }

        // Carregar ranking
        async function loadRanking() {
            try {
                const { data, error } = await supabase
                    .from('ranking_jogadores')
                    .select('*')
                    .limit(10);

                if (error) throw error;

                let tableHTML = `
                    <table class="ranking-table">
                        <thead>
                            <tr>
                                <th>Posi√ß√£o</th>
                                <th>Nome</th>
                                <th>Pontua√ß√£o</th>
                                <th>Acertos</th>
                                <th>Dicas Usadas</th>
                                <th>Data</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                if (data && data.length > 0) {
                    data.forEach(player => {
                        const medal = player.posicao === 1 ? 'ü•á' : 
                                     player.posicao === 2 ? 'ü•à' : 
                                     player.posicao === 3 ? 'ü•â' : '';
                        
                        tableHTML += `
                            <tr>
                                <td><span class="medal">${medal}</span>${player.posicao}¬∞</td>
                                <td>${player.nome}</td>
                                <td>${player.pontuacao}</td>
                                <td>${player.percentual_acerto}%</td>
                                <td>${player.total_dicas_usadas}</td>
                                <td>${new Date(player.data_conclusao).toLocaleDateString('pt-BR')}</td>
                            </tr>
                        `;
                    });
                } else {
                    tableHTML += `
                        <tr>
                            <td colspan="6" style="text-align: center; color: #ffd700; padding: 20px;">
                                üöÄ Seja o primeiro a completar uma miss√£o!
                            </td>
                        </tr>
                    `;
                }

                tableHTML += `
                        </tbody>
                    </table>
                `;

                document.getElementById('rankingContainer').innerHTML = tableHTML;
            } catch (error) {
                throw error;
            }
        }

        // Reiniciar jogo
        function restartGame() {
            totalScore = 0;
            currentChallenge = 0;
            currentHints = 0;
            challengesCompleted = 0;
            totalAttempts = 0;
            totalHintsUsed = 0;
            challengeDetails = [];
            gameStartTime = null;
            challengeStartTime = null;
            
            document.getElementById('score').textContent = '0';
            showScreen('missionSelect');
        }

        // Mostrar tela
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        // Event listener para Enter
        document.getElementById('answerInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                submitAnswer();
            }
        });

        // Inicializar
        createStars();
        
        // Verificar conex√£o periodicamente
        setInterval(() => {
            if (supabase && !isSupabaseConnected) {
                testConnection();
            }
        }, 30000); // Testa a cada 30 segundos
    </script>
</body>
</html>
